trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/**
      - public/**
      - package.json
      - package-lock.json
      - pipelines/ui-pipeline.yml

pool:
  vmImage: ubuntu-latest

variables:
  NODE_VERSION: "20.x"
  AZURE_SERVICE_CONNECTION: "moath-sp-new"

stages:
# ============================
# BUILD ONCE
# ============================
- stage: Build
  displayName: "Build UI"
  jobs:
  - job: BuildUI
    steps:
    - checkout: self

    - task: NodeTool@0
      inputs:
        versionSpec: $(NODE_VERSION)
      displayName: "Use Node $(NODE_VERSION)"

    # ✅ REAL FINAL BUILD (ROOT)
    - script: |
        set -e
        npm ci
        npm run build
      displayName: "Install & Build UI"

    # ✅ REAL FINAL ARCHIVE (ROOT build/)
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: "build"
        includeRootFolder: false
        archiveType: zip
        archiveFile: "$(Build.ArtifactStagingDirectory)/ui.zip"
        replaceExistingArchive: true
      displayName: "Archive build output"

    - publish: "$(Build.ArtifactStagingDirectory)/ui.zip"
      artifact: drop
      displayName: "Publish artifact"

# ============================
# DEV
# ============================
- stage: Dev
  displayName: "Deploy DEV"
  dependsOn: Build
  variables:
    APP_SERVICE_NAME: "ui-moath-dev"
    REACT_APP_API_BASE_URL: "https://apim-moath-dev-v2.azure-api.net"
  jobs:
  - deployment: DeployDev
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: "Deploy UI to DEV App Service"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_SERVICE_NAME)
              package: "$(Pipeline.Workspace)/drop/ui.zip"

          - task: AzureAppServiceSettings@1
            displayName: "Configure DEV runtime (Node 20) + startup"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_SERVICE_NAME)
              appSettings: |
                [
                  { "name": "WEBSITES_PORT", "value": "8080", "slotSetting": false },
                  { "name": "NODE_ENV", "value": "production", "slotSetting": false },
                  { "name": "REACT_APP_API_BASE_URL", "value": "$(REACT_APP_API_BASE_URL)", "slotSetting": false }
                ]
              generalSettings: |
                {
                  "linuxFxVersion": "NODE|20-lts",
                  "appCommandLine": "npx serve -s build --listen 8080"
                }

# ============================
# QA
# ============================
- stage: QA
  displayName: "Deploy QA"
  dependsOn: Dev
  variables:
    APP_SERVICE_NAME: "ui-moath-qa"
    REACT_APP_API_BASE_URL: "https://apim-moath-qa-v2.azure-api.net"
  jobs:
  - deployment: DeployQA
    environment: qa
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: "Deploy UI to QA App Service"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_SERVICE_NAME)
              package: "$(Pipeline.Workspace)/drop/ui.zip"

          - task: AzureAppServiceSettings@1
            displayName: "Configure QA runtime (Node 20) + startup"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_SERVICE_NAME)
              appSettings: |
                [
                  { "name": "WEBSITES_PORT", "value": "8080", "slotSetting": false },
                  { "name": "NODE_ENV", "value": "production", "slotSetting": false },
                  { "name": "REACT_APP_API_BASE_URL", "value": "$(REACT_APP_API_BASE_URL)", "slotSetting": false }
                ]
              generalSettings: |
                {
                  "linuxFxVersion": "NODE|20-lts",
                  "appCommandLine": "npx serve -s build --listen 8080"
                }

# ============================
# PROD
# ============================
- stage: Prod
  displayName: "Deploy PROD"
  dependsOn: QA
  variables:
    APP_SERVICE_NAME: "ui-moath-prod"
    REACT_APP_API_BASE_URL: "https://apim-moath-prod-v2.azure-api.net"
  jobs:
  - deployment: DeployProd
    environment: prod
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: "Deploy UI to PROD App Service"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_SERVICE_NAME)
              package: "$(Pipeline.Workspace)/drop/ui.zip"

          - task: AzureAppServiceSettings@1
            displayName: "Configure PROD runtime (Node 20) + startup"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_SERVICE_NAME)
              appSettings: |
                [
                  { "name": "WEBSITES_PORT", "value": "8080", "slotSetting": false },
                  { "name": "NODE_ENV", "value": "production", "slotSetting": false },
                  { "name": "REACT_APP_API_BASE_URL", "value": "$(REACT_APP_API_BASE_URL)", "slotSetting": false }
                ]
              generalSettings: |
                {
                  "linuxFxVersion": "NODE|20-lts",
                  "appCommandLine": "npx serve -s build --listen 8080"
                }
